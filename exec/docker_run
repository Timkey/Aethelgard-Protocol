#!/bin/bash
# Universal wrapper to execute Python scripts in worker container
# Usage: docker_run <script_path> [args...]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

# Check if containers are running
if ! docker ps | grep -q planetary_exodus_qdrant; then
    echo "üöÄ Starting containers..."
    docker-compose up -d
    echo "‚è≥ Waiting for Qdrant to be ready..."
    
    # Wait for Qdrant health check
    max_attempts=30
    attempt=0
    while [ $attempt -lt $max_attempts ]; do
        if docker-compose exec -T qdrant curl -sf http://localhost:6333/health > /dev/null 2>&1; then
            echo "‚úÖ Qdrant is ready"
            break
        fi
        attempt=$((attempt + 1))
        sleep 1
    done
    
    if [ $attempt -eq $max_attempts ]; then
        echo "‚ùå Qdrant failed to start"
        exit 1
    fi
fi

# Execute command in worker container
docker-compose exec -T worker python3 "$@"
